{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>
        Glitch
        Getaway
        -
        Terminal</title>
    <link rel="stylesheet"
          href="{% static 'style.css' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body class="terminal">
<button id="theme-switcher"
        style="position: fixed; top: 10px; right: 10px; padding: 5px 10px; cursor: pointer;">
    Switch
    Theme
</button>

<div class="terminal-screen">
    <div class="terminal-header">
        <p>
            GlitchGetaway
            v1.0</p>
    </div>
    <div class="terminal-body">
        <pre class="flicker">[[ PROGRESS ]] {{ progress.bar }} {{ progress.solved }}/{{ progress.total }}</pre>

        <pre class="flicker">[[ SYSTEM MESSAGE ]]</pre>
        <pre>{{ room.description }}</pre>
        <pre class="flicker">[[ HINT ]] Press â†‘ / â†“ to recall previous commands like a real terminal.</pre>

        <pre class="flicker">[[ PUZZLE ]]</pre>
        <pre>{{ room.puzzle_question }}</pre>
        {% if error %}
            <pre class="flicker error">{{ error }}</pre>
        {% endif %}

        <pre>>> <span id="user-typing" class="blink-cursor"></span></pre>


        <form id="hidden-form"
              method="POST"
              style="display:none;">
            {% csrf_token %}
            <input type="hidden"
                   name="answer"
                   id="hidden-answer">
        </form>
    </div>
</div>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        const body = document.querySelector('body');
        let theme = localStorage.getItem('theme');

        // Theme Setup
        if (!theme) {
            const currentHour = new Date().getHours();
            theme = (currentHour >= 7 && currentHour <= 19) ? 'light' : 'dark';
            localStorage.setItem('theme', theme);
        }

        applyTheme(theme);

        const switcher = document.getElementById('theme-switcher');
        let darkMode = (theme === 'dark');

        switcher.addEventListener('click', () => {
            darkMode = !darkMode;
            theme = darkMode ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
            applyTheme(theme);
        });

        function applyTheme(theme) {
            if (theme === 'light') {
                body.style.setProperty('--background-color', 'white');
                body.style.setProperty('--text-color', 'black');
                body.style.setProperty('--border-color', 'black');
                body.style.setProperty('--header-text-color', 'white');
            } else {
                body.style.setProperty('--background-color', 'black');
                body.style.setProperty('--text-color', '#00FF00');
                body.style.setProperty('--border-color', '#00FF00');
                body.style.setProperty('--header-text-color', 'black');
            }
        }

        // ðŸ§  Command History Navigation
        let currentInput = '';
        let commandHistory = JSON.parse(sessionStorage.getItem('history') || '[]');
        let historyIndex = commandHistory.length;

        const userTyping = document.getElementById('user-typing');
        const hiddenForm = document.getElementById('hidden-form');
        const hiddenAnswer = document.getElementById('hidden-answer');

        const mobileInput = document.getElementById('mobile-input');

// Always keep input focused so the mobile keyboard stays visible
        setInterval(() => {
            if (document.activeElement !== mobileInput) {
                mobileInput.focus();
            }
        }, 500);

// Mirror typing to the fake terminal
        mobileInput.addEventListener('input', () => {
            currentInput = mobileInput.value;
            userTyping.textContent = currentInput + '|';
        });

// Support Enter from virtual keyboard
        mobileInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (currentInput.trim() !== '') {
                    commandHistory.push(currentInput);
                    sessionStorage.setItem('history', JSON.stringify(commandHistory));
                    historyIndex = commandHistory.length;
                }

                hiddenAnswer.value = currentInput;
                hiddenForm.submit();
                currentInput = '';
                mobileInput.value = '';
                userTyping.textContent = '|';
            }
        });

        // ðŸ§¹ Clear history per room load
        sessionStorage.removeItem('history');

        document.addEventListener('keydown', function (e) {
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (historyIndex > 0) {
                    historyIndex--;
                    currentInput = commandHistory[historyIndex];
                    userTyping.textContent = currentInput + '|';
                }
                return;
            }

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    currentInput = commandHistory[historyIndex];
                } else {
                    historyIndex = commandHistory.length;
                    currentInput = '';
                }
                userTyping.textContent = currentInput + '|';
                return;
            }

            if (e.key === 'Backspace') {
                currentInput = currentInput.slice(0, -1);
            } else if (e.key === 'Enter') {
                if (currentInput.trim() !== '') {
                    commandHistory.push(currentInput);
                    sessionStorage.setItem('history', JSON.stringify(commandHistory));
                    historyIndex = commandHistory.length;
                }

                hiddenAnswer.value = currentInput;
                hiddenForm.submit();
                currentInput = '';
            } else if (e.key.length === 1) {
                currentInput += e.key;
            }

            userTyping.textContent = currentInput + '|';
        });
    });
</script>
<input id="mobile-input" style="position:absolute; left:-9999px;" autofocus>
</body>
</html>